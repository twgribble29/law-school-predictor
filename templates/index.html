{% extends "base.html" %}
{% block title %}Law School Predictor{% endblock %}

{% block content %}
<div class="container">
    <header class="hero">
        <h1>Predict Your Law School Chances</h1>
        <p class="subtitle"><a href="/methodology" style="color:var(--green-500);text-decoration:none;border-bottom:1px dashed var(--green-300)">Machine learning</a>-powered admissions predictions for 193 ABA-accredited law schools</p>
    </header>

    <form id="prediction-form" autocomplete="off">
        <!-- Profile Section -->
        <section class="card">
            <h2 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                Your Profile
            </h2>

            <div class="form-grid-2">
                <div class="form-group">
                    <label for="lsat">LSAT Score</label>
                    <input type="number" id="lsat" min="120" max="180" step="1" placeholder="120-180" required>
                </div>
                <div class="form-group">
                    <label for="gpa">GPA</label>
                    <input type="number" id="gpa" min="0" max="4.33" step="0.01" placeholder="0.00-4.33" required>
                </div>
            </div>

            <div class="form-grid-3">
                <div class="form-group">
                    <label for="softs">Softs Tier
                        <span class="info-tip">i<span class="tip-content"><strong>What are "Softs"?</strong><br>
                        Softs are non-numerical components of your application, including work experience, extracurriculars, personal statements, and letters of recommendation.<br><br>
                        <strong>Tier Definitions:</strong>
                        <ul>
                            <li><strong>T1 (Exceptional):</strong> Rhodes/Marshall/Fulbright Scholar, Olympic athlete, patents, significant publications, elite military service, senior leadership at major organizations</li>
                            <li><strong>T2 (Strong):</strong> Peace Corps, Teach For America, AmeriCorps, impressive work experience (3+ years), noteworthy internships, student body president, Division I athlete, published research</li>
                            <li><strong>T3 (Average):</strong> Standard internships, typical club leadership, good letters of recommendation, decent work experience (1-2 years), volunteer work, study abroad</li>
                            <li><strong>T4 (Weakest):</strong> Minimal to no relevant work experience, standard extracurriculars, no significant leadership roles</li>
                        </ul>
                        <a href="https://www.lsd.law/softs" target="_blank" rel="noopener noreferrer">Read more about softs at LSD.Law &rarr;</a></span></span>
                    </label>
                    <select id="softs">
                        <option value="0">Not Reported</option>
                        <option value="1">T4 (Weakest)</option>
                        <option value="2" selected>T3 (Average)</option>
                        <option value="3">T2 (Strong)</option>
                        <option value="4">T1 (Exceptional)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="timing">Application Timing</label>
                    <select id="timing">
                        <option value="30">September</option>
                        <option value="60">October</option>
                        <option value="90" selected>November</option>
                        <option value="120">December</option>
                        <option value="150">January</option>
                        <option value="180">February+</option>
                    </select>
                    <button type="button" class="date-toggle-btn" id="toggle-exact-date" onclick="toggleExactDate()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        Know your exact date?
                    </button>
                    <div id="exact-date-picker" style="display:none; margin-top:6px;">
                        <input type="date" id="exact-date" min="2024-09-01" max="2025-08-31" class="exact-date-input" onchange="updateTimingFromDate(this.value)">
                        <span class="helper-text" style="font-size:0.82rem; display:block; margin-top:3px;">We'll calculate timing days automatically</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="years_out">Years Since Undergrad</label>
                    <input type="number" id="years_out" min="0" max="30" step="1" value="0">
                </div>
            </div>

            <div class="toggle-row">
                <label class="toggle-label">
                    <input type="checkbox" id="urm">
                    <span class="toggle-switch"></span>
                    <span>URM Status</span>
                </label>
                <label class="toggle-label">
                    <input type="checkbox" id="has_we">
                    <span class="toggle-switch"></span>
                    <span>Work Experience</span>
                </label>
            </div>
        </section>

        <!-- School Selection Section -->
        <section class="card">
            <h2 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
                Select Schools
            </h2>

            <div class="school-search-wrap">
                <input type="text" id="school-search" placeholder="Search for a school..." class="school-search">
                <div id="school-dropdown" class="school-dropdown"></div>
            </div>

            <div class="quick-add">
                <button type="button" class="chip-btn t14-btn" id="add-t14">+ All T14</button>
                <span class="info-tip">i<span class="tip-content"><strong>T14</strong> refers to the 14 law schools that have historically held the top positions in US News rankings. They are considered the most prestigious and competitive law programs.</span></span>
                <button type="button" class="chip-btn" id="add-t25">+ T25</button>
                <span class="info-tip">i<span class="tip-content"><strong>T25</strong> refers to the top 25 law schools by selectivity. These schools are highly competitive but slightly broader than the T14, including excellent programs like UCLA, Vanderbilt, and UT Austin.</span></span>
                <button type="button" class="chip-btn" id="clear-schools">Clear All</button>
            </div>

            <div id="selected-schools" class="selected-schools"></div>
            <p id="school-count" class="helper-text">No schools selected</p>
        </section>

        <!-- Import Profile Section (Optional) - Hidden for now -->
        <section class="card" id="import-section" style="display:none">
            <h2 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                Import Profile
                <span class="optional-tag">Optional</span>
            </h2>
            <p class="helper-text" style="margin-bottom:12px">Paste your LSD.Law profile data or upload a CSV to auto-fill your stats, schools, and decisions.</p>

            <div class="import-tabs">
                <button type="button" class="import-tab active" onclick="switchImportTab('paste')" id="tab-paste">Paste JSON</button>
                <button type="button" class="import-tab" onclick="switchImportTab('csv')" id="tab-csv">Upload CSV</button>
            </div>

            <div id="import-paste" class="import-panel">
                <textarea id="import-json" class="import-textarea" rows="5" placeholder='{"lsat": 170, "gpa": 3.8, "schools": ["Yale University", "Harvard University"], "decisions": [{"school": "Columbia University", "result": "Accepted"}]}'></textarea>
                <button type="button" class="chip-btn" onclick="importFromJSON()" style="margin-top:8px;">Import Data</button>
            </div>

            <div id="import-csv" class="import-panel" style="display:none;">
                <input type="file" id="csv-upload" accept=".csv,.tsv" class="csv-input" onchange="importFromCSV(event)">
                <p class="helper-text" style="margin-top:6px; font-size:0.82rem;">CSV should have columns: school_name, result (Accepted/Waitlisted/Rejected). Optionally include lsat, gpa.</p>
            </div>

            <div id="import-status" style="margin-top:8px;"></div>
        </section>

        <!-- Decisions Section (Optional) -->
        <section class="card">
            <h2 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                Decisions Received
                <span class="optional-tag">Optional</span>
            </h2>
            <p class="helper-text" style="margin-bottom:16px">Adding decisions from other schools improves prediction accuracy by leveraging the enhanced model.</p>

            <div id="decisions-container"></div>
            <button type="button" class="add-decision-btn" id="add-decision-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Add Decision
            </button>
        </section>

        <button type="submit" class="predict-btn" id="predict-btn">
            <span class="btn-text">Predict My Chances</span>
            <span class="btn-loading" style="display:none">
                <svg class="spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="12" cy="12" r="10" stroke-dasharray="60" stroke-dashoffset="20"/></svg>
                Calculating...
            </span>
        </button>
    </form>

    <!-- Results Section -->
    <section id="results" class="results-section" style="display:none">
        <div class="results-header">
            <h2>Your Admission Chances</h2>
            <p id="model-info" class="model-badge"></p>
        </div>

        <div id="summary-panel" class="summary-panel" style="display:none"></div>
        <div class="results-grid" id="results-grid"></div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
const ALL_SCHOOLS = {{ schools_json | safe }};
const T14_NAMES = {{ t14_json | safe }};
const T25_NAMES = ALL_SCHOOLS.filter(s => ALL_SCHOOLS.indexOf(s) < 25).map(s => s.name);

let selectedSchools = new Set();

// ── School Abbreviation Map ────────────────────────────────────────
const SCHOOL_ALIASES = {
    'nyu': 'New York University',
    'ucla': 'University of California\u2014Los Angeles',
    'uc berkeley': 'University of California\u2014Berkeley',
    'berkeley': 'University of California\u2014Berkeley',
    'cal berkeley': 'University of California\u2014Berkeley',
    'uva': 'University of Virginia',
    'umich': 'University of Michigan',
    'upenn': 'University of Pennsylvania',
    'penn': 'University of Pennsylvania',
    'uchicago': 'University of Chicago',
    'chicago': 'University of Chicago',
    'gulc': 'Georgetown University',
    'gtown': 'Georgetown University',
    'byu': 'Brigham Young University',
    'bu': 'Boston University',
    'bc': 'Boston College',
    'wustl': 'Washington University in St. Louis',
    'wash u': 'Washington University in St. Louis',
    'unc': 'University of North Carolina',
    'osu': 'Ohio State University',
    'ut austin': 'University of Texas at Austin',
    'ut': 'University of Texas at Austin',
    'asu': 'Arizona State University',
    'gw': 'George Washington University',
    'gwu': 'George Washington University',
    'gmu': 'George Mason University',
    'smu': 'Southern Methodist University',
    'usc': 'University of Southern California',
    'nd': 'University of Notre Dame',
    'notre dame': 'University of Notre Dame',
    'ufl': 'University of Florida',
    'uga': 'University of Georgia',
};

function matchesSchool(school, query) {
    if (school.name.toLowerCase().includes(query)) return true;
    // Check if query matches any alias for this school
    for (const [alias, fullName] of Object.entries(SCHOOL_ALIASES)) {
        if (alias.includes(query) && fullName === school.name) return true;
    }
    return false;
}

// ── School Search & Selection ──────────────────────────────────────
const searchInput = document.getElementById('school-search');
const dropdown = document.getElementById('school-dropdown');
const selectedContainer = document.getElementById('selected-schools');

searchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();
    dropdown.innerHTML = '';
    if (query.length < 2) { dropdown.style.display = 'none'; return; }

    // Check for exact alias match first
    const aliasMatch = SCHOOL_ALIASES[query];

    const matches = ALL_SCHOOLS.filter(s =>
        matchesSchool(s, query) && !selectedSchools.has(s.name)
    ).slice(0, 10);

    // Sort: put exact alias match first if present
    if (aliasMatch) {
        matches.sort((a, b) => {
            if (a.name === aliasMatch) return -1;
            if (b.name === aliasMatch) return 1;
            return 0;
        });
    }

    if (matches.length === 0) { dropdown.style.display = 'none'; return; }

    matches.forEach(school => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        const logoUrl = school.domain
            ? `https://www.google.com/s2/favicons?domain=${school.domain}&sz=32`
            : '';
        item.innerHTML = `
            ${logoUrl ? `<img src="${logoUrl}" class="school-icon-sm" alt="" onerror="this.style.display='none'">` : '<span class="school-icon-placeholder-sm"></span>'}
            <span class="dropdown-name">${school.name}</span>
            ${school.is_t14 ? '<span class="t14-badge">T14</span>' : ''}
        `;
        item.addEventListener('click', () => {
            addSchool(school.name);
            searchInput.value = '';
            dropdown.style.display = 'none';
        });
        dropdown.appendChild(item);
    });
    dropdown.style.display = 'block';
});

searchInput.addEventListener('blur', () => setTimeout(() => dropdown.style.display = 'none', 200));

function addSchool(name) {
    if (selectedSchools.has(name)) return;
    selectedSchools.add(name);
    renderSelectedSchools();
}

function removeSchool(name) {
    selectedSchools.delete(name);
    renderSelectedSchools();
}

function renderSelectedSchools() {
    const arr = Array.from(selectedSchools);
    // Sort by selectivity (most competitive first)
    arr.sort((a, b) => {
        const sa = ALL_SCHOOLS.find(s => s.name === a);
        const sb = ALL_SCHOOLS.find(s => s.name === b);
        return (sb ? sb.selectivity : 0) - (sa ? sa.selectivity : 0);
    });

    selectedContainer.innerHTML = arr.map(name => {
        const school = ALL_SCHOOLS.find(s => s.name === name);
        const logoUrl = school && school.domain
            ? `https://www.google.com/s2/favicons?domain=${school.domain}&sz=32`
            : '';
        const t14 = school && school.is_t14 ? ' t14' : '';
        return `<div class="school-chip${t14}">
            ${logoUrl ? `<img src="${logoUrl}" class="chip-icon" alt="" onerror="this.style.display='none'">` : ''}
            <span>${name}</span>
            <button type="button" class="chip-remove" onclick="removeSchool('${name.replace(/'/g, "\\'")}')">&times;</button>
        </div>`;
    }).join('');

    const count = selectedSchools.size;
    document.getElementById('school-count').textContent =
        count === 0 ? 'No schools selected' : `${count} school${count > 1 ? 's' : ''} selected`;
}

// Quick-add buttons
document.getElementById('add-t14').addEventListener('click', () => {
    T14_NAMES.forEach(name => addSchool(name));
});
document.getElementById('add-t25').addEventListener('click', () => {
    T25_NAMES.forEach(name => addSchool(name));
});
document.getElementById('clear-schools').addEventListener('click', () => {
    selectedSchools.clear();
    renderSelectedSchools();
});

// ── Decision Inputs ────────────────────────────────────────────────
let decisionCount = 0;
document.getElementById('add-decision-btn').addEventListener('click', addDecision);

function addDecision() {
    const container = document.getElementById('decisions-container');
    const div = document.createElement('div');
    div.className = 'decision-row';
    div.innerHTML = `
        <select class="decision-school" required>
            <option value="">Select School</option>
            ${ALL_SCHOOLS.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
        </select>
        <select class="decision-result">
            <option value="Accepted">Accepted</option>
            <option value="Waitlisted">Waitlisted</option>
            <option value="Rejected">Rejected</option>
        </select>
        <button type="button" class="decision-remove" onclick="this.parentElement.remove()">&times;</button>
    `;
    container.appendChild(div);
    decisionCount++;
}

// ── Exact Date Picker ──────────────────────────────────────────────
function toggleExactDate() {
    const picker = document.getElementById('exact-date-picker');
    const btn = document.getElementById('toggle-exact-date');
    const select = document.getElementById('timing');
    if (picker.style.display === 'none') {
        picker.style.display = 'block';
        select.disabled = true;
        select.style.opacity = '0.5';
        btn.textContent = 'Use month selector instead';
    } else {
        picker.style.display = 'none';
        select.disabled = false;
        select.style.opacity = '1';
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> Know your exact date?';
        document.getElementById('exact-date').value = '';
    }
}

function updateTimingFromDate(dateStr) {
    if (!dateStr) return;
    const date = new Date(dateStr);
    // Calculate days after September 1 of the cycle year
    const cycleYear = date.getMonth() >= 8 ? date.getFullYear() : date.getFullYear() - 1;
    const sept1 = new Date(cycleYear, 8, 1); // Sept 1
    const diffDays = Math.max(1, Math.round((date - sept1) / (1000 * 60 * 60 * 24)));
    // Store the computed value as a data attribute
    document.getElementById('exact-date').dataset.timingDays = diffDays;
}

function getTimingDays() {
    const exactDate = document.getElementById('exact-date');
    if (exactDate.value && exactDate.dataset.timingDays) {
        return parseInt(exactDate.dataset.timingDays);
    }
    return parseInt(document.getElementById('timing').value);
}

// ── Import Profile ────────────────────────────────────────────────
function switchImportTab(tab) {
    document.getElementById('import-paste').style.display = tab === 'paste' ? 'block' : 'none';
    document.getElementById('import-csv').style.display = tab === 'csv' ? 'block' : 'none';
    document.getElementById('tab-paste').classList.toggle('active', tab === 'paste');
    document.getElementById('tab-csv').classList.toggle('active', tab === 'csv');
}

function importFromJSON() {
    const raw = document.getElementById('import-json').value.trim();
    const status = document.getElementById('import-status');
    if (!raw) { status.innerHTML = '<span style="color:var(--coral-500)">Please paste your profile data.</span>'; return; }

    try {
        const data = JSON.parse(raw);
        let imported = [];

        // Fill stats
        if (data.lsat) { document.getElementById('lsat').value = data.lsat; imported.push('LSAT'); }
        if (data.gpa) { document.getElementById('gpa').value = data.gpa; imported.push('GPA'); }
        if (data.softs != null) { document.getElementById('softs').value = data.softs; imported.push('Softs'); }
        if (data.is_urm != null) { document.getElementById('urm').checked = !!data.is_urm; imported.push('URM'); }
        if (data.has_we != null || data.work_experience != null) {
            document.getElementById('has_we').checked = !!(data.has_we || data.work_experience);
            imported.push('Work Experience');
        }
        if (data.years_out != null) { document.getElementById('years_out').value = data.years_out; imported.push('Years Out'); }

        // Add schools
        if (data.schools && Array.isArray(data.schools)) {
            data.schools.forEach(s => {
                const name = typeof s === 'string' ? s : s.name;
                if (name && ALL_SCHOOLS.find(sch => sch.name === name)) {
                    addSchool(name);
                }
            });
            imported.push(data.schools.length + ' schools');
        }

        // Add decisions
        if (data.decisions && Array.isArray(data.decisions)) {
            data.decisions.forEach(d => {
                if (d.school && d.result) {
                    addDecision();
                    const rows = document.querySelectorAll('.decision-row');
                    const lastRow = rows[rows.length - 1];
                    const schoolSelect = lastRow.querySelector('.decision-school');
                    const resultSelect = lastRow.querySelector('.decision-result');
                    // Try to match school name
                    for (let opt of schoolSelect.options) {
                        if (opt.value === d.school) { schoolSelect.value = d.school; break; }
                    }
                    resultSelect.value = d.result;
                }
            });
            imported.push(data.decisions.length + ' decisions');
        }

        status.innerHTML = `<span style="color:var(--green-600)">Imported: ${imported.join(', ')}</span>`;
    } catch (e) {
        status.innerHTML = `<span style="color:var(--coral-500)">Invalid JSON: ${e.message}</span>`;
    }
}

function importFromCSV(event) {
    const file = event.target.files[0];
    const status = document.getElementById('import-status');
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const text = e.target.result;
            const sep = text.includes('\t') ? '\t' : ',';
            const lines = text.trim().split('\n');
            const headers = lines[0].split(sep).map(h => h.trim().toLowerCase().replace(/"/g, ''));

            const schoolCol = headers.findIndex(h => h.includes('school'));
            const resultCol = headers.findIndex(h => h.includes('result') || h.includes('decision') || h.includes('status'));
            const lsatCol = headers.findIndex(h => h === 'lsat');
            const gpaCol = headers.findIndex(h => h === 'gpa');

            let schoolsAdded = 0, decisionsAdded = 0;

            // Fill LSAT/GPA from first data row if available
            if (lines.length > 1) {
                const firstRow = lines[1].split(sep).map(v => v.trim().replace(/"/g, ''));
                if (lsatCol >= 0 && firstRow[lsatCol]) {
                    document.getElementById('lsat').value = parseFloat(firstRow[lsatCol]);
                }
                if (gpaCol >= 0 && firstRow[gpaCol]) {
                    document.getElementById('gpa').value = parseFloat(firstRow[gpaCol]);
                }
            }

            for (let i = 1; i < lines.length; i++) {
                const vals = lines[i].split(sep).map(v => v.trim().replace(/"/g, ''));
                if (vals.length < 2) continue;

                const schoolName = schoolCol >= 0 ? vals[schoolCol] : '';
                const result = resultCol >= 0 ? vals[resultCol] : '';

                if (schoolName) {
                    // Find matching school
                    const match = ALL_SCHOOLS.find(s => s.name.toLowerCase().includes(schoolName.toLowerCase()) || schoolName.toLowerCase().includes(s.name.toLowerCase()));
                    if (match) {
                        addSchool(match.name);
                        schoolsAdded++;

                        // If there's a result, add as decision
                        if (result && ['accepted', 'waitlisted', 'rejected'].includes(result.toLowerCase())) {
                            addDecision();
                            const rows = document.querySelectorAll('.decision-row');
                            const lastRow = rows[rows.length - 1];
                            lastRow.querySelector('.decision-school').value = match.name;
                            const resultVal = result.charAt(0).toUpperCase() + result.slice(1).toLowerCase();
                            lastRow.querySelector('.decision-result').value = resultVal;
                            decisionsAdded++;
                        }
                    }
                }
            }

            status.innerHTML = `<span style="color:var(--green-600)">Imported ${schoolsAdded} schools, ${decisionsAdded} decisions from CSV</span>`;
        } catch (e) {
            status.innerHTML = `<span style="color:var(--coral-500)">Error parsing CSV: ${e.message}</span>`;
        }
    };
    reader.readAsText(file);
}

// ── Form Submission ────────────────────────────────────────────────
document.getElementById('prediction-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    if (selectedSchools.size === 0) {
        alert('Please select at least one school.');
        return;
    }

    const lsat = parseInt(document.getElementById('lsat').value);
    const gpa = parseFloat(document.getElementById('gpa').value);
    if (lsat < 120 || lsat > 180) { alert('LSAT must be between 120 and 180.'); return; }
    if (gpa < 0 || gpa > 4.33) { alert('GPA must be between 0.00 and 4.33.'); return; }

    // Collect decisions
    const decisions = [];
    document.querySelectorAll('.decision-row').forEach(row => {
        const school = row.querySelector('.decision-school').value;
        const result = row.querySelector('.decision-result').value;
        if (school) decisions.push({ school, result });
    });

    const payload = {
        lsat,
        gpa,
        timing_days: getTimingDays(),
        softs: parseInt(document.getElementById('softs').value),
        is_urm: document.getElementById('urm').checked,
        has_we: document.getElementById('has_we').checked,
        years_out: parseFloat(document.getElementById('years_out').value) || 0,
        cycle_year: 2025,
        decisions,
        schools: Array.from(selectedSchools)
    };

    // Loading state
    const btn = document.getElementById('predict-btn');
    btn.querySelector('.btn-text').style.display = 'none';
    btn.querySelector('.btn-loading').style.display = 'inline-flex';
    btn.disabled = true;

    try {
        const res = await fetch('/predict', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.status === 'error') { alert('Error: ' + data.message); return; }
        renderResults(data);
    } catch (err) {
        alert('Error: ' + err.message);
    } finally {
        btn.querySelector('.btn-text').style.display = 'inline';
        btn.querySelector('.btn-loading').style.display = 'none';
        btn.disabled = false;
    }
});

// ── Box-and-Whisker SVG Builder (Enhanced) ────────────────────────
function buildBoxWhisker(label, min, q25, q50, q75, max, applicantVal, scaleMin, scaleMax) {
    const W = 280, H = 56, PAD = 24, TOP = 20;
    const plotW = W - PAD * 2;
    const range = scaleMax - scaleMin || 1;
    const x = v => PAD + ((v - scaleMin) / range) * plotW;
    const midY = TOP + 14;

    const boxL = x(q25), boxR = x(q75), medX = x(q50);
    const whiskerL = x(min), whiskerR = x(max);
    const appX = Math.max(PAD, Math.min(W - PAD, x(applicantVal)));

    // Determine if applicant is above/below median
    const appColor = applicantVal >= q50 ? '#2D9B83' : '#E76F51';

    // Format value for display
    const fmt = label === 'LSAT' ? v => Math.round(v) : v => v.toFixed(2);

    return `<svg viewBox="0 0 ${W} ${H}" class="bw-chart" style="height:56px">
        <!-- Bold label -->
        <text x="2" y="12" font-size="10" font-weight="600" fill="#3D4F47" font-family="Inter,sans-serif">${label}</text>
        <!-- Quartile value labels -->
        <text x="${boxL}" y="12" font-size="7.5" fill="#8FA69C" font-family="Inter,sans-serif" text-anchor="middle">${fmt(q25)}</text>
        <text x="${medX}" y="12" font-size="7.5" font-weight="600" fill="#1B6B4F" font-family="Inter,sans-serif" text-anchor="middle">${fmt(q50)}</text>
        <text x="${boxR}" y="12" font-size="7.5" fill="#8FA69C" font-family="Inter,sans-serif" text-anchor="middle">${fmt(q75)}</text>
        <!-- Whisker line -->
        <line x1="${whiskerL}" y1="${midY}" x2="${whiskerR}" y2="${midY}" stroke="#B4C7BF" stroke-width="1.5"/>
        <!-- Whisker caps -->
        <line x1="${whiskerL}" y1="${midY-6}" x2="${whiskerL}" y2="${midY+6}" stroke="#B4C7BF" stroke-width="1.5"/>
        <line x1="${whiskerR}" y1="${midY-6}" x2="${whiskerR}" y2="${midY+6}" stroke="#B4C7BF" stroke-width="1.5"/>
        <!-- Box (IQR) -->
        <rect x="${boxL}" y="${midY-10}" width="${boxR - boxL}" height="20" rx="3" fill="#E8F7F3" stroke="#86D9C2" stroke-width="1.5"/>
        <!-- Median line -->
        <line x1="${medX}" y1="${midY-10}" x2="${medX}" y2="${midY+10}" stroke="#1B6B4F" stroke-width="2.5"/>
        <!-- Applicant marker (diamond) -->
        <polygon points="${appX},${midY-12} ${appX+6},${midY} ${appX},${midY+12} ${appX-6},${midY}" fill="${appColor}" stroke="white" stroke-width="1"/>
        <!-- Applicant value label -->
        <text x="${appX}" y="${midY+22}" font-size="7.5" font-weight="600" fill="${appColor}" font-family="Inter,sans-serif" text-anchor="middle">${fmt(applicantVal)}</text>
        <!-- Min/max labels -->
        <text x="${whiskerL}" y="${midY+16}" font-size="7" fill="#B4C7BF" font-family="Inter,sans-serif" text-anchor="middle">${fmt(min)}</text>
        <text x="${whiskerR}" y="${midY+16}" font-size="7" fill="#B4C7BF" font-family="Inter,sans-serif" text-anchor="middle">${fmt(max)}</text>
    </svg>`;
}

// ── Tooltip System (Click-to-toggle on all devices) ───────────────
(function initTooltips() {
    document.querySelectorAll('.info-tip').forEach(tip => {
        const content = tip.querySelector('.tip-content');
        if (!content) return;

        tip.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            // Close any other open tooltips
            document.querySelectorAll('.tip-content.show').forEach(t => {
                if (t !== content) t.classList.remove('show');
            });

            content.classList.toggle('show');

            // Position for mobile: always center on screen
            if (content.classList.contains('show') && window.innerWidth < 768) {
                const rect = tip.getBoundingClientRect();
                content.style.position = 'fixed';
                content.style.left = '50%';
                content.style.transform = 'translateX(-50%)';
                content.style.width = 'calc(100vw - 2rem)';
                content.style.maxWidth = '360px';
                content.style.zIndex = '9999';
                if (rect.top > window.innerHeight / 2) {
                    content.style.bottom = (window.innerHeight - rect.top + 8) + 'px';
                    content.style.top = 'auto';
                } else {
                    content.style.top = (rect.bottom + 8) + 'px';
                    content.style.bottom = 'auto';
                }
            } else if (content.classList.contains('show')) {
                // Desktop: reset any mobile positioning
                content.style.position = '';
                content.style.left = '';
                content.style.transform = '';
                content.style.width = '';
                content.style.maxWidth = '';
                content.style.zIndex = '';
                content.style.top = '';
                content.style.bottom = '';
            }
        });
    });

    // Close tooltips when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.info-tip')) {
            document.querySelectorAll('.tip-content.show').forEach(t => {
                t.classList.remove('show');
                t.style.position = '';
                t.style.left = '';
                t.style.transform = '';
                t.style.width = '';
                t.style.maxWidth = '';
                t.style.zIndex = '';
                t.style.top = '';
                t.style.bottom = '';
            });
        }
    });
})();

// ── Ordinal Formatting Helper ──────────────────────────────────────
function getOrdinal(n) {
    const s = ['th', 'st', 'nd', 'rd'];
    const v = n % 100;
    return n + (s[(v - 20) % 10] || s[v] || s[0]);
}

// ── Render Results ─────────────────────────────────────────────────
function renderResults(data) {
    const section = document.getElementById('results');
    const grid = document.getElementById('results-grid');
    const app = data.applicant;

    // Collect decisions map for badge display
    const decisionMap = {};
    document.querySelectorAll('.decision-row').forEach(row => {
        const school = row.querySelector('.decision-school').value;
        const result = row.querySelector('.decision-result').value;
        if (school) decisionMap[school] = result;
    });

    // Model info badge
    const modelType = data.model_type === 'enhanced'
        ? 'Enhanced Model (using decisions)'
        : 'Baseline Model';
    const urmText = data.is_urm ? 'URM' : 'Non-URM';

    // Confidence badge
    const conf = data.confidence || 'standard';
    const confLabels = {
        high: 'High Confidence',
        standard: 'Standard Confidence',
        limited: 'Limited Data'
    };
    const confTips = {
        high: 'You provided detailed profile information, so these predictions are well-calibrated.',
        standard: 'Predictions are based on core stats. Adding softs, work experience, or decisions can improve accuracy.',
        limited: 'Only LSAT and GPA are being used. Add more profile data for better-calibrated predictions.'
    };
    document.getElementById('model-info').innerHTML =
        `${modelType} &middot; ${urmText} &middot; <span class="confidence-badge ${conf}" title="${confTips[conf]}">${confLabels[conf]}</span>`;

    grid.innerHTML = '';

    data.predictions.forEach(pred => {
        let category, catClass;
        if (pred.probability >= 70) { category = 'Safety'; catClass = 'safety'; }
        else if (pred.probability >= 30) { category = 'Target'; catClass = 'target'; }
        else { category = 'Reach'; catClass = 'reach'; }

        const logoUrl = pred.domain
            ? `https://www.google.com/s2/favicons?domain=${pred.domain}&sz=64`
            : '';

        const st = pred.stats || {};
        let chartsHtml = '';
        if (st.lsat_25) {
            chartsHtml = `
                <div class="bw-row">
                    ${buildBoxWhisker('LSAT', st.lsat_min, st.lsat_25, st.lsat_50, st.lsat_75, st.lsat_max, app.lsat, st.lsat_min - 2, st.lsat_max + 2)}
                    ${buildBoxWhisker('GPA', st.gpa_min, st.gpa_25, st.gpa_50, st.gpa_75, st.gpa_max, app.gpa, st.gpa_min - 0.1, st.gpa_max + 0.1)}
                </div>
                <div class="bw-legend">
                    <span class="bw-legend-item"><span class="bw-swatch" style="background:#E8F7F3;border:1px solid #86D9C2"></span>25th&ndash;75th of admits</span>
                    <span class="bw-legend-item"><span class="bw-swatch" style="background:#1B6B4F"></span>Median</span>
                    <span class="bw-legend-item"><svg width="10" height="10" viewBox="0 0 10 10"><polygon points="5,0 10,5 5,10 0,5" fill="#2D9B83"/></svg> You</span>
                </div>`;
        }

        // Compute waitlist & reject estimates from accept probability
        const pAccept = pred.probability;
        const wlFraction = pred.waitlist_rate || 0.15;
        const pWaitlist = Math.round((100 - pAccept) * wlFraction * 10) / 10;
        const pReject = Math.round((100 - pAccept - pWaitlist) * 10) / 10;

        // Selectivity percentile label
        const selPctHtml = pred.selectivity_percentile != null
            ? `Selectivity: ${getOrdinal(Math.round(pred.selectivity_percentile))} percentile`
            : `Selectivity: ${pred.selectivity}`;

        const card = document.createElement('div');
        card.className = `result-card ${catClass}`;
        card.innerHTML = `
            <div class="result-card-top">
                <div class="result-school-info">
                    ${logoUrl
                        ? `<img src="${logoUrl}" class="result-logo" alt="" onerror="this.classList.add('hidden')">`
                        : '<div class="result-logo-placeholder"></div>'}
                    <div>
                        <div class="result-school-name"><a href="/schools?open=${encodeURIComponent(pred.school)}" class="school-name-link">${pred.school}</a>${decisionMap[pred.school] ? `<span class="decision-badge ${decisionMap[pred.school].toLowerCase()}">${decisionMap[pred.school]}</span>` : ''}</div>
                        <div class="result-meta">${pred.is_t14 ? '<span class="t14-badge">T14</span> ' : ''}${selPctHtml}</div>
                    </div>
                </div>
                <div class="result-prob-wrap">
                    <div class="result-prob ${catClass}">${pred.probability}%</div>
                    <div class="result-category ${catClass}">${category}</div>
                </div>
            </div>
            <div class="outcome-bars">
                <div class="outcome-row">
                    <span class="outcome-label"><span class="outcome-icon accept">&#10003;</span> Accept</span>
                    <div class="probability-bar">
                        <div class="bar-fill accept" style="width:${Math.max(pAccept, 2)}%"><span class="bar-pct ${pAccept < 15 ? 'outside' : 'inside'}">${pAccept}%</span></div>
                    </div>
                </div>
                <div class="outcome-row">
                    <span class="outcome-label"><span class="outcome-icon waitlist">&#8214;</span> Waitlist</span>
                    <div class="probability-bar">
                        <div class="bar-fill waitlist" style="width:${Math.max(pWaitlist, 2)}%"><span class="bar-pct ${pWaitlist < 15 ? 'outside' : 'inside'}">${pWaitlist}%</span></div>
                    </div>
                </div>
                <div class="outcome-row">
                    <span class="outcome-label"><span class="outcome-icon reject">&#10007;</span> Reject</span>
                    <div class="probability-bar">
                        <div class="bar-fill reject" style="width:${Math.max(pReject, 2)}%"><span class="bar-pct ${pReject < 15 ? 'outside' : 'inside'}">${pReject}%</span></div>
                    </div>
                </div>
            </div>
            ${chartsHtml}
            ${pred.marginal ? `
            <div class="marginal-tip">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                ${pred.marginal.label} &rarr; <span class="marginal-delta">+${pred.marginal.delta}%</span> probability
            </div>` : ''}
        `;
        grid.appendChild(card);
    });

    // ── Summary Panel ──────────────────────────────────────────────
    const preds = data.predictions;
    const safetyCount = preds.filter(p => p.probability >= 70).length;
    const targetCount = preds.filter(p => p.probability >= 30 && p.probability < 70).length;
    const reachCount = preds.filter(p => p.probability < 30).length;

    // P(at least one acceptance) = 1 - product(1 - p_i)
    const pNone = preds.reduce((acc, p) => acc * (1 - p.probability / 100), 1);
    const pAtLeastOne = Math.round((1 - pNone) * 1000) / 10;

    const avgProb = preds.length > 0
        ? Math.round(preds.reduce((s, p) => s + p.probability, 0) / preds.length * 10) / 10
        : 0;

    const summaryPanel = document.getElementById('summary-panel');
    summaryPanel.innerHTML = `
        <h3>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            Application Strategy Summary
        </h3>
        <div class="summary-stats-row">
            <div class="summary-stat">
                <div class="summary-stat-value">${pAtLeastOne}%</div>
                <div class="summary-stat-label">Chance of at least<br>one acceptance</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value">${avgProb}%</div>
                <div class="summary-stat-label">Average probability<br>across schools</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value">${preds.length}</div>
                <div class="summary-stat-label">Schools in<br>your list</div>
            </div>
        </div>
        <div class="summary-distribution">
            <div class="summary-dist-item safety">
                <div class="summary-dist-count safety">${safetyCount}</div>
                <div class="summary-dist-label">Safety (70%+)</div>
            </div>
            <div class="summary-dist-item target">
                <div class="summary-dist-count target">${targetCount}</div>
                <div class="summary-dist-label">Target (30-70%)</div>
            </div>
            <div class="summary-dist-item reach">
                <div class="summary-dist-count reach">${reachCount}</div>
                <div class="summary-dist-label">Reach (&lt;30%)</div>
            </div>
        </div>
        <div class="summary-actions">
            <a href="/schools" class="summary-action-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
                Explore School Profiles
            </a>
            <a href="/methodology" class="summary-action-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                How predictions work
            </a>
            <span class="summary-action-link" onclick="window.scrollTo({top:0,behavior:'smooth'})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 014-4h14"/></svg>
                Adjust &amp; re-predict
            </span>
        </div>
        <div class="summary-actions" style="margin-top:10px;border-top:1px solid var(--gray-200);padding-top:14px;">
            <span class="summary-action-link" onclick="copyShareLink()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
                <span id="copy-link-text">Copy Shareable Link</span>
            </span>
            <span class="summary-action-link" onclick="downloadResultsImage()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Download as Image
            </span>
        </div>
    `;
    summaryPanel.style.display = 'block';

    // Store current prediction data for sharing
    window._lastPredictionPayload = {
        lsat: parseInt(document.getElementById('lsat').value),
        gpa: parseFloat(document.getElementById('gpa').value),
        timing: document.getElementById('timing').value,
        softs: document.getElementById('softs').value,
        urm: document.getElementById('urm').checked ? '1' : '0',
        we: document.getElementById('has_we').checked ? '1' : '0',
        years: document.getElementById('years_out').value,
        schools: Array.from(selectedSchools).join(',')
    };

    section.style.display = 'block';
    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ── Shareable Link ─────────────────────────────────────────────────
function copyShareLink() {
    const p = window._lastPredictionPayload;
    if (!p) return;
    const params = new URLSearchParams(p);
    const url = window.location.origin + '/?' + params.toString();
    navigator.clipboard.writeText(url).then(() => {
        const el = document.getElementById('copy-link-text');
        el.textContent = 'Link Copied!';
        setTimeout(() => { el.textContent = 'Copy Shareable Link'; }, 2000);
    }).catch(() => {
        // Fallback for older browsers
        const input = document.createElement('input');
        input.value = url;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        const el = document.getElementById('copy-link-text');
        el.textContent = 'Link Copied!';
        setTimeout(() => { el.textContent = 'Copy Shareable Link'; }, 2000);
    });
}

// ── Download Results as Image ──────────────────────────────────────
function downloadResultsImage() {
    const section = document.getElementById('results');
    // Use canvas to capture the results section
    const canvas = document.createElement('canvas');
    const scale = 2; // High DPI
    const rect = section.getBoundingClientRect();
    canvas.width = rect.width * scale;
    canvas.height = rect.height * scale;
    const ctx = canvas.getContext('2d');
    ctx.scale(scale, scale);
    ctx.fillStyle = '#F6F8F7';
    ctx.fillRect(0, 0, rect.width, rect.height);

    // Simple text-based image of results
    ctx.fillStyle = '#0D3B2C';
    ctx.font = 'bold 24px Inter, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Law School Predictor - Results', rect.width / 2, 40);

    ctx.font = '14px Inter, sans-serif';
    ctx.fillStyle = '#6B7F75';
    ctx.fillText('law-school-predictor.onrender.com', rect.width / 2, 62);

    let y = 100;
    const preds = document.querySelectorAll('.result-card');
    ctx.textAlign = 'left';

    preds.forEach(card => {
        const name = card.querySelector('.result-school-name')?.textContent?.trim() || '';
        const prob = card.querySelector('.result-prob')?.textContent?.trim() || '';
        const cat = card.querySelector('.result-category')?.textContent?.trim() || '';

        // Category color
        if (cat.toLowerCase() === 'safety') ctx.fillStyle = '#2D9B83';
        else if (cat.toLowerCase() === 'target') ctx.fillStyle = '#E9A84C';
        else ctx.fillStyle = '#E76F51';

        ctx.fillRect(20, y - 2, 4, 22);

        ctx.fillStyle = '#1A2420';
        ctx.font = '600 15px Inter, sans-serif';
        ctx.fillText(name, 32, y + 14);

        ctx.fillStyle = ctx.fillStyle;
        ctx.textAlign = 'right';
        ctx.font = 'bold 16px Inter, sans-serif';
        if (cat.toLowerCase() === 'safety') ctx.fillStyle = '#1B6B4F';
        else if (cat.toLowerCase() === 'target') ctx.fillStyle = '#E9A84C';
        else ctx.fillStyle = '#E76F51';
        ctx.fillText(prob, rect.width - 20, y + 14);
        ctx.textAlign = 'left';

        y += 28;
        if (y > canvas.height / scale - 40) return;
    });

    // Footer
    ctx.fillStyle = '#8FA69C';
    ctx.font = '12px Inter, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Generated by Law School Predictor', rect.width / 2, y + 20);

    canvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'law-school-predictions.png';
        a.click();
        URL.revokeObjectURL(url);
    }, 'image/png');
}

// ── Auto-fill from URL params (shareable link) ─────────────────────
(function loadFromURL() {
    const params = new URLSearchParams(window.location.search);
    if (!params.has('lsat')) return; // No shared link params

    if (params.get('lsat')) document.getElementById('lsat').value = params.get('lsat');
    if (params.get('gpa')) document.getElementById('gpa').value = params.get('gpa');
    if (params.get('timing')) document.getElementById('timing').value = params.get('timing');
    if (params.get('softs')) document.getElementById('softs').value = params.get('softs');
    if (params.get('urm') === '1') document.getElementById('urm').checked = true;
    if (params.get('we') === '1') document.getElementById('has_we').checked = true;
    if (params.get('years')) document.getElementById('years_out').value = params.get('years');
    if (params.get('schools')) {
        params.get('schools').split(',').forEach(name => {
            if (ALL_SCHOOLS.find(s => s.name === name)) addSchool(name);
        });
    }
})();
</script>
{% endblock %}
