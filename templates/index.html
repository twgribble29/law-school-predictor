{% extends "base.html" %}
{% block title %}Law School Predictor{% endblock %}

{% block content %}
<div class="container">
    <header class="hero">
        <h1>Predict Your Law School Chances</h1>
        <p class="subtitle"><a href="/methodology" style="color:var(--green-500);text-decoration:none;border-bottom:1px dashed var(--green-300)">Machine learning</a>-powered admissions predictions for 193 ABA-accredited law schools</p>
    </header>

    <form id="prediction-form" autocomplete="off">
        <!-- Profile Section -->
        <section class="card">
            <h2 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                Your Profile
            </h2>

            <div class="form-grid-2">
                <div class="form-group">
                    <label for="lsat">LSAT Score</label>
                    <input type="number" id="lsat" min="120" max="180" step="1" placeholder="120-180" required>
                </div>
                <div class="form-group">
                    <label for="gpa">GPA</label>
                    <input type="number" id="gpa" min="0" max="4.33" step="0.01" placeholder="0.00-4.33" required>
                </div>
            </div>

            <div class="form-grid-3">
                <div class="form-group">
                    <label for="softs">Softs Tier
                        <span class="info-tip">i<span class="tip-content"><strong>Softs Tiers</strong> rate your extracurriculars, leadership, and work quality:<br>
                        <strong>T1:</strong> Exceptional (Rhodes Scholar, Olympic athlete, published author)<br>
                        <strong>T2:</strong> Strong (significant leadership, notable achievements)<br>
                        <strong>T3:</strong> Average (standard clubs, volunteering, internships)<br>
                        <strong>T4:</strong> Weak (minimal activities)<br>
                        <a href="https://www.lsd.law" target="_blank">Learn more at LSD.Law</a></span></span>
                    </label>
                    <select id="softs">
                        <option value="0">Not Reported</option>
                        <option value="1">T4 (Weakest)</option>
                        <option value="2" selected>T3 (Average)</option>
                        <option value="3">T2 (Strong)</option>
                        <option value="4">T1 (Exceptional)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="timing">Application Timing</label>
                    <select id="timing">
                        <option value="30">September (Very Early)</option>
                        <option value="60">October (Early)</option>
                        <option value="90" selected>November (Standard)</option>
                        <option value="120">December (Late)</option>
                        <option value="150">January (Very Late)</option>
                        <option value="180">February+ (Rolling)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="years_out">Years Since Undergrad</label>
                    <input type="number" id="years_out" min="0" max="30" step="1" value="0">
                </div>
            </div>

            <div class="toggle-row">
                <label class="toggle-label">
                    <input type="checkbox" id="urm">
                    <span class="toggle-switch"></span>
                    <span>URM Status</span>
                </label>
                <label class="toggle-label">
                    <input type="checkbox" id="has_we">
                    <span class="toggle-switch"></span>
                    <span>Work Experience</span>
                </label>
            </div>
        </section>

        <!-- School Selection Section -->
        <section class="card">
            <h2 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
                Select Schools
            </h2>

            <div class="school-search-wrap">
                <input type="text" id="school-search" placeholder="Search for a school..." class="school-search">
                <div id="school-dropdown" class="school-dropdown"></div>
            </div>

            <div class="quick-add">
                <button type="button" class="chip-btn t14-btn" id="add-t14">+ All T14</button>
                <span class="info-tip">i<span class="tip-content"><strong>T14</strong> refers to the 14 law schools that have historically held the top positions in US News rankings. They are considered the most prestigious and competitive law programs.</span></span>
                <button type="button" class="chip-btn" id="add-t25">+ T25</button>
                <span class="info-tip">i<span class="tip-content"><strong>T25</strong> refers to the top 25 law schools by selectivity. These schools are highly competitive but slightly broader than the T14, including excellent programs like UCLA, Vanderbilt, and UT Austin.</span></span>
                <button type="button" class="chip-btn" id="clear-schools">Clear All</button>
            </div>

            <div id="selected-schools" class="selected-schools"></div>
            <p id="school-count" class="helper-text">No schools selected</p>
        </section>

        <!-- Decisions Section (Optional) -->
        <section class="card">
            <h2 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                Decisions Received
                <span class="optional-tag">Optional</span>
            </h2>
            <p class="helper-text" style="margin-bottom:16px">Adding decisions from other schools improves prediction accuracy by leveraging the enhanced model.</p>

            <div id="decisions-container"></div>
            <button type="button" class="add-decision-btn" id="add-decision-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Add Decision
            </button>
        </section>

        <button type="submit" class="predict-btn" id="predict-btn">
            <span class="btn-text">Predict My Chances</span>
            <span class="btn-loading" style="display:none">
                <svg class="spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><circle cx="12" cy="12" r="10" stroke-dasharray="60" stroke-dashoffset="20"/></svg>
                Calculating...
            </span>
        </button>
    </form>

    <!-- Results Section -->
    <section id="results" class="results-section" style="display:none">
        <div class="results-header">
            <h2>Your Admission Chances</h2>
            <p id="model-info" class="model-badge"></p>
        </div>

        <div class="results-grid" id="results-grid"></div>
        <div id="summary-panel" class="summary-panel" style="display:none"></div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
const ALL_SCHOOLS = {{ schools_json | safe }};
const T14_NAMES = {{ t14_json | safe }};
const T25_NAMES = ALL_SCHOOLS.filter(s => ALL_SCHOOLS.indexOf(s) < 25).map(s => s.name);

let selectedSchools = new Set();

// ── School Search & Selection ──────────────────────────────────────
const searchInput = document.getElementById('school-search');
const dropdown = document.getElementById('school-dropdown');
const selectedContainer = document.getElementById('selected-schools');

searchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();
    dropdown.innerHTML = '';
    if (query.length < 2) { dropdown.style.display = 'none'; return; }

    const matches = ALL_SCHOOLS.filter(s =>
        s.name.toLowerCase().includes(query) && !selectedSchools.has(s.name)
    ).slice(0, 10);

    if (matches.length === 0) { dropdown.style.display = 'none'; return; }

    matches.forEach(school => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        const logoUrl = school.domain
            ? `https://www.google.com/s2/favicons?domain=${school.domain}&sz=32`
            : '';
        item.innerHTML = `
            ${logoUrl ? `<img src="${logoUrl}" class="school-icon-sm" alt="" onerror="this.style.display='none'">` : '<span class="school-icon-placeholder-sm"></span>'}
            <span class="dropdown-name">${school.name}</span>
            ${school.is_t14 ? '<span class="t14-badge">T14</span>' : ''}
        `;
        item.addEventListener('click', () => {
            addSchool(school.name);
            searchInput.value = '';
            dropdown.style.display = 'none';
        });
        dropdown.appendChild(item);
    });
    dropdown.style.display = 'block';
});

searchInput.addEventListener('blur', () => setTimeout(() => dropdown.style.display = 'none', 200));

function addSchool(name) {
    if (selectedSchools.has(name)) return;
    selectedSchools.add(name);
    renderSelectedSchools();
}

function removeSchool(name) {
    selectedSchools.delete(name);
    renderSelectedSchools();
}

function renderSelectedSchools() {
    const arr = Array.from(selectedSchools);
    // Sort by selectivity (most competitive first)
    arr.sort((a, b) => {
        const sa = ALL_SCHOOLS.find(s => s.name === a);
        const sb = ALL_SCHOOLS.find(s => s.name === b);
        return (sb ? sb.selectivity : 0) - (sa ? sa.selectivity : 0);
    });

    selectedContainer.innerHTML = arr.map(name => {
        const school = ALL_SCHOOLS.find(s => s.name === name);
        const logoUrl = school && school.domain
            ? `https://www.google.com/s2/favicons?domain=${school.domain}&sz=32`
            : '';
        const t14 = school && school.is_t14 ? ' t14' : '';
        return `<div class="school-chip${t14}">
            ${logoUrl ? `<img src="${logoUrl}" class="chip-icon" alt="" onerror="this.style.display='none'">` : ''}
            <span>${name}</span>
            <button type="button" class="chip-remove" onclick="removeSchool('${name.replace(/'/g, "\\'")}')">&times;</button>
        </div>`;
    }).join('');

    const count = selectedSchools.size;
    document.getElementById('school-count').textContent =
        count === 0 ? 'No schools selected' : `${count} school${count > 1 ? 's' : ''} selected`;
}

// Quick-add buttons
document.getElementById('add-t14').addEventListener('click', () => {
    T14_NAMES.forEach(name => addSchool(name));
});
document.getElementById('add-t25').addEventListener('click', () => {
    T25_NAMES.forEach(name => addSchool(name));
});
document.getElementById('clear-schools').addEventListener('click', () => {
    selectedSchools.clear();
    renderSelectedSchools();
});

// ── Decision Inputs ────────────────────────────────────────────────
let decisionCount = 0;
document.getElementById('add-decision-btn').addEventListener('click', addDecision);

function addDecision() {
    const container = document.getElementById('decisions-container');
    const div = document.createElement('div');
    div.className = 'decision-row';
    div.innerHTML = `
        <select class="decision-school" required>
            <option value="">Select School</option>
            ${ALL_SCHOOLS.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
        </select>
        <select class="decision-result">
            <option value="Accepted">Accepted</option>
            <option value="Waitlisted">Waitlisted</option>
            <option value="Rejected">Rejected</option>
        </select>
        <button type="button" class="decision-remove" onclick="this.parentElement.remove()">&times;</button>
    `;
    container.appendChild(div);
    decisionCount++;
}

// ── Form Submission ────────────────────────────────────────────────
document.getElementById('prediction-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    if (selectedSchools.size === 0) {
        alert('Please select at least one school.');
        return;
    }

    const lsat = parseInt(document.getElementById('lsat').value);
    const gpa = parseFloat(document.getElementById('gpa').value);
    if (lsat < 120 || lsat > 180) { alert('LSAT must be between 120 and 180.'); return; }
    if (gpa < 0 || gpa > 4.33) { alert('GPA must be between 0.00 and 4.33.'); return; }

    // Collect decisions
    const decisions = [];
    document.querySelectorAll('.decision-row').forEach(row => {
        const school = row.querySelector('.decision-school').value;
        const result = row.querySelector('.decision-result').value;
        if (school) decisions.push({ school, result });
    });

    const payload = {
        lsat,
        gpa,
        timing_days: parseInt(document.getElementById('timing').value),
        softs: parseInt(document.getElementById('softs').value),
        is_urm: document.getElementById('urm').checked,
        has_we: document.getElementById('has_we').checked,
        years_out: parseFloat(document.getElementById('years_out').value) || 0,
        cycle_year: 2025,
        decisions,
        schools: Array.from(selectedSchools)
    };

    // Loading state
    const btn = document.getElementById('predict-btn');
    btn.querySelector('.btn-text').style.display = 'none';
    btn.querySelector('.btn-loading').style.display = 'inline-flex';
    btn.disabled = true;

    try {
        const res = await fetch('/predict', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.status === 'error') { alert('Error: ' + data.message); return; }
        renderResults(data);
    } catch (err) {
        alert('Error: ' + err.message);
    } finally {
        btn.querySelector('.btn-text').style.display = 'inline';
        btn.querySelector('.btn-loading').style.display = 'none';
        btn.disabled = false;
    }
});

// ── Box-and-Whisker SVG Builder ────────────────────────────────────
function buildBoxWhisker(label, min, q25, q50, q75, max, applicantVal, scaleMin, scaleMax) {
    const W = 240, H = 36, PAD = 20;
    const plotW = W - PAD * 2;
    const range = scaleMax - scaleMin || 1;
    const x = v => PAD + ((v - scaleMin) / range) * plotW;

    const boxL = x(q25), boxR = x(q75), medX = x(q50);
    const whiskerL = x(min), whiskerR = x(max);
    const appX = Math.max(PAD, Math.min(W - PAD, x(applicantVal)));

    // Determine if applicant is above/below median
    const appColor = applicantVal >= q50 ? '#2D9B83' : '#E76F51';

    return `<svg viewBox="0 0 ${W} ${H}" class="bw-chart">
        <!-- Whisker line -->
        <line x1="${whiskerL}" y1="18" x2="${whiskerR}" y2="18" stroke="#B4C7BF" stroke-width="1.5"/>
        <!-- Whisker caps -->
        <line x1="${whiskerL}" y1="12" x2="${whiskerL}" y2="24" stroke="#B4C7BF" stroke-width="1.5"/>
        <line x1="${whiskerR}" y1="12" x2="${whiskerR}" y2="24" stroke="#B4C7BF" stroke-width="1.5"/>
        <!-- Box (IQR) -->
        <rect x="${boxL}" y="8" width="${boxR - boxL}" height="20" rx="3" fill="#E8F7F3" stroke="#86D9C2" stroke-width="1.5"/>
        <!-- Median line -->
        <line x1="${medX}" y1="8" x2="${medX}" y2="28" stroke="#1B6B4F" stroke-width="2"/>
        <!-- Applicant marker (diamond) -->
        <polygon points="${appX},6 ${appX+6},18 ${appX},30 ${appX-6},18" fill="${appColor}" stroke="white" stroke-width="1"/>
        <!-- Label -->
        <text x="2" y="7" font-size="8" fill="#6B7F75" font-family="Inter,sans-serif">${label}</text>
    </svg>`;
}

// ── Render Results ─────────────────────────────────────────────────
function renderResults(data) {
    const section = document.getElementById('results');
    const grid = document.getElementById('results-grid');
    const app = data.applicant;

    // Collect decisions map for badge display
    const decisionMap = {};
    document.querySelectorAll('.decision-row').forEach(row => {
        const school = row.querySelector('.decision-school').value;
        const result = row.querySelector('.decision-result').value;
        if (school) decisionMap[school] = result;
    });

    // Model info badge
    const modelType = data.model_type === 'enhanced'
        ? 'Enhanced Model (using decisions)'
        : 'Baseline Model';
    const urmText = data.is_urm ? 'URM' : 'Non-URM';
    document.getElementById('model-info').textContent = `${modelType} \u00b7 ${urmText}`;

    grid.innerHTML = '';

    data.predictions.forEach(pred => {
        let category, catClass;
        if (pred.probability >= 70) { category = 'Safety'; catClass = 'safety'; }
        else if (pred.probability >= 30) { category = 'Target'; catClass = 'target'; }
        else { category = 'Reach'; catClass = 'reach'; }

        const logoUrl = pred.domain
            ? `https://www.google.com/s2/favicons?domain=${pred.domain}&sz=64`
            : '';

        const st = pred.stats || {};
        let chartsHtml = '';
        if (st.lsat_25) {
            chartsHtml = `
                <div class="bw-row">
                    ${buildBoxWhisker('LSAT', st.lsat_min, st.lsat_25, st.lsat_50, st.lsat_75, st.lsat_max, app.lsat, st.lsat_min - 2, st.lsat_max + 2)}
                    ${buildBoxWhisker('GPA', st.gpa_min, st.gpa_25, st.gpa_50, st.gpa_75, st.gpa_max, app.gpa, st.gpa_min - 0.1, st.gpa_max + 0.1)}
                </div>
                <div class="bw-legend">
                    <span class="bw-legend-item"><span class="bw-swatch" style="background:#E8F7F3;border:1px solid #86D9C2"></span>25th-75th of admits</span>
                    <span class="bw-legend-item"><span class="bw-swatch" style="background:#1B6B4F"></span>Median</span>
                    <span class="bw-legend-item"><svg width="10" height="10" viewBox="0 0 10 10"><polygon points="5,0 10,5 5,10 0,5" fill="#2D9B83"/></svg> You</span>
                </div>`;
        }

        const card = document.createElement('div');
        card.className = `result-card ${catClass}`;
        card.innerHTML = `
            <div class="result-card-top">
                <div class="result-school-info">
                    ${logoUrl
                        ? `<img src="${logoUrl}" class="result-logo" alt="" onerror="this.classList.add('hidden')">`
                        : '<div class="result-logo-placeholder"></div>'}
                    <div>
                        <div class="result-school-name">${pred.school}${decisionMap[pred.school] ? `<span class="decision-badge ${decisionMap[pred.school].toLowerCase()}">${decisionMap[pred.school]}</span>` : ''}</div>
                        <div class="result-meta">${pred.is_t14 ? '<span class="t14-badge">T14</span> ' : ''}Selectivity: ${pred.selectivity}</div>
                    </div>
                </div>
                <div class="result-prob-wrap">
                    <div class="result-prob ${catClass}">${pred.probability}%</div>
                    <div class="result-category ${catClass}">${category}</div>
                </div>
            </div>
            ${chartsHtml}
            ${pred.marginal ? `
            <div class="marginal-tip">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                ${pred.marginal.label} &rarr; <span class="marginal-delta">+${pred.marginal.delta}%</span> probability
            </div>` : ''}
            <div class="result-bar-bg">
                <div class="result-bar ${catClass}" style="width:${Math.min(pred.probability, 100)}%"></div>
            </div>
        `;
        grid.appendChild(card);
    });

    // ── Summary Panel ──────────────────────────────────────────────
    const preds = data.predictions;
    const safetyCount = preds.filter(p => p.probability >= 70).length;
    const targetCount = preds.filter(p => p.probability >= 30 && p.probability < 70).length;
    const reachCount = preds.filter(p => p.probability < 30).length;

    // P(at least one acceptance) = 1 - product(1 - p_i)
    const pNone = preds.reduce((acc, p) => acc * (1 - p.probability / 100), 1);
    const pAtLeastOne = Math.round((1 - pNone) * 1000) / 10;

    const avgProb = preds.length > 0
        ? Math.round(preds.reduce((s, p) => s + p.probability, 0) / preds.length * 10) / 10
        : 0;

    const summaryPanel = document.getElementById('summary-panel');
    summaryPanel.innerHTML = `
        <h3>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            Application Strategy Summary
        </h3>
        <div class="summary-stats-row">
            <div class="summary-stat">
                <div class="summary-stat-value">${pAtLeastOne}%</div>
                <div class="summary-stat-label">Chance of at least<br>one acceptance</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value">${avgProb}%</div>
                <div class="summary-stat-label">Average probability<br>across schools</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value">${preds.length}</div>
                <div class="summary-stat-label">Schools in<br>your list</div>
            </div>
        </div>
        <div class="summary-distribution">
            <div class="summary-dist-item safety">
                <div class="summary-dist-count safety">${safetyCount}</div>
                <div class="summary-dist-label">Safety (70%+)</div>
            </div>
            <div class="summary-dist-item target">
                <div class="summary-dist-count target">${targetCount}</div>
                <div class="summary-dist-label">Target (30-70%)</div>
            </div>
            <div class="summary-dist-item reach">
                <div class="summary-dist-count reach">${reachCount}</div>
                <div class="summary-dist-label">Reach (&lt;30%)</div>
            </div>
        </div>
        <div class="summary-actions">
            <a href="/schools" class="summary-action-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
                Explore School Profiles
            </a>
            <a href="/methodology" class="summary-action-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                How predictions work
            </a>
            <span class="summary-action-link" onclick="window.scrollTo({top:0,behavior:'smooth'})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 014-4h14"/></svg>
                Adjust &amp; re-predict
            </span>
        </div>
    `;
    summaryPanel.style.display = 'block';

    section.style.display = 'block';
    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
}
</script>
{% endblock %}
